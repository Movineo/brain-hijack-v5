<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PRAXIS | Command Center</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { background-color: #0d1117; color: #c9d1d9; font-family: "Courier New", monospace; padding: 10px; margin: 0; }
        
        /* LAYOUT GRID */
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            display: grid; 
            grid-template-columns: 2fr 1fr;
            gap: 15px; 
        }
        
        /* HEADER (Spans full width) */
        .header { 
            grid-column: 1 / -1; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid #30363d; 
            padding-bottom: 10px; 
            margin-bottom: 5px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .status-box { padding: 5px 12px; border-radius: 4px; font-weight: bold; font-size: 0.75em; text-transform: uppercase; white-space: nowrap; }
        .normal { background-color: #238636; color: white; }
        .critical { background-color: #da3633; color: white; animation: pulse 0.8s infinite; }

        /* PANELS */
        .panel { background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 12px; overflow: hidden; }
        .panel-title { font-weight: bold; color: #8b949e; margin-bottom: 12px; border-bottom: 1px solid #30363d; padding-bottom: 5px; text-transform: uppercase; font-size: 0.8em; }

        /* TABLE */
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { text-align: left; border-bottom: 1px solid #30363d; padding: 8px 6px; color: #8b949e; font-size: 0.7em; white-space: nowrap; }
        td { padding: 6px; border-bottom: 1px solid #21262d; font-size: 0.8em; white-space: nowrap; }
        tr.asset-row:hover { background-color: #21262d; cursor: pointer; }

        /* HEATMAP */
        #heatmapContainer { position: relative; height: 300px; }

        /* HIGHLIGHTS */
        .ticker { font-weight: bold; color: #58a6ff; }
        .force-high { color: #da3633; font-weight: bold; }
        .force-low { color: #238636; opacity: 0.7; }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: #0d1117; margin: 5% auto; padding: 15px; border: 1px solid #30363d; width: 95%; max-width: 800px; border-radius: 8px; }
        .close { color: #aaa; float: right; font-size: 28px; cursor: pointer; }

        #startOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); color: #00ff00; display: flex; justify-content: center; align-items: center; font-size: 1.5em; cursor: pointer; z-index: 999; flex-direction: column; padding: 20px; text-align: center; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* STAT BOXES */
        .stats-grid { display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
        .stat-box { background: #21262d; padding: 8px 12px; border-radius: 6px; text-align: center; min-width: 70px; flex: 1; }
        .stat-box div:first-child { font-size: 0.6em; }
        .stat-box div:last-child { font-size: 1.2em; }
        .profit { color: #238636; }
        .loss { color: #da3633; }

        /* INTEL PANELS - 3 column grid for small cards */
        .intel-row { 
            grid-column: 1 / -1; 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 15px; 
        }
        .intel-row .panel { min-height: 150px; }

        /* MOBILE RESPONSIVE */
        @media (max-width: 900px) { 
            .container { grid-template-columns: 1fr; }
            body { padding: 8px; }
        }
        
        @media (max-width: 600px) {
            .header h1 { font-size: 1.1em !important; }
            .header > div:first-child > div { font-size: 0.7em !important; }
            #startOverlay { font-size: 1.2em; }
            .panel { padding: 10px; }
            .panel-title { font-size: 0.75em; margin-bottom: 10px; }
            table { min-width: 450px; }
            th, td { padding: 5px 4px; font-size: 0.7em; }
            .stat-box { min-width: 60px; padding: 6px 8px; }
            .stat-box div:first-child { font-size: 0.55em; }
            .stat-box div:last-child { font-size: 1em; }
            #heatmapContainer { height: 200px; }
            .modal-content { margin: 10% auto; padding: 10px; }
        }
        
        @media (max-width: 400px) {
            table { min-width: 400px; }
            th, td { padding: 4px 3px; font-size: 0.65em; }
            .stats-grid { gap: 6px; }
            .stat-box { min-width: 50px; padding: 5px 6px; }
        }
    </style>
</head>
<body>

<audio id="alertSound" src="https://www.soundjay.com/buttons/beep-01a.mp3" preload="auto"></audio>

<div id="startOverlay" onclick="enableAudio()">
    <div>[ INITIALIZE PRAXIS ]</div>
    <div style="font-size: 0.5em; margin-top: 10px; color: #888;">Connecting to Coinbase Stream...</div>
</div>

<div id="chartModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle" style="color:#58a6ff;"></h2>
        <canvas id="modalCanvas"></canvas>
    </div>
</div>

<div class="container">
    <div class="header">
        <div>
            <h1 style="margin:0; font-size: 1.5em;">// PRAXIS COMMAND</h1>
            <div style="font-size: 0.8em; color:#8b949e;">MONITORING 20+ ASSETS [COINBASE STREAM]</div>
        </div>
        <div id="globalStatus" class="status-box normal">SECURE</div>
    </div>

    <div class="panel">
        <div class="panel-title">Hijack Force Leaderboard</div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>RK</th>
                        <th>ASSET</th>
                        <th>PRICE ($)</th>
                        <th>FORCE</th>
                        <th>NEWS</th>
                        <th>STATUS</th>
                    </tr>
                </thead>
                <tbody id="gridBody"></tbody>
            </table>
        </div>
    </div>

    <div class="panel">
        <div class="panel-title">1-Hour Volume Pressure</div>
        <div id="heatmapContainer">
            <canvas id="heatmapCanvas"></canvas>
        </div>
    </div>

    <!-- MARKET INTELLIGENCE ROW -->
    <div class="intel-row">
        <div class="panel">
            <div class="panel-title">üìä Fear & Greed Index</div>
            <div id="fearGreedPanel" style="text-align:center; padding: 10px;">
                <div id="fearGreedGauge" style="font-size: 3em; font-weight: bold; color: #58a6ff;">--</div>
                <div id="fearGreedLabel" style="font-size: 1.2em; color: #8b949e;">Loading...</div>
                <div id="fearGreedComponents" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px; justify-content: center;"></div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">ÔøΩ Social Sentiment</div>
            <div id="twitterPanel" style="padding: 10px;">
                <div id="twitterTrending" style="margin-bottom: 10px;"></div>
                <div id="twitterMentions" style="font-size: 0.8em; color: #8b949e;"></div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">ü§ñ ML Predictions</div>
            <div id="mlPanel" style="padding: 10px;">
                <div id="mlHighConfidence" style="font-size: 0.9em;"></div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">üìà Options Flow</div>
            <div id="optionsPanel" style="padding: 10px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <div id="optionsSentiment" style="font-size: 1.5em; font-weight: bold;">--</div>
                    <div id="optionsPCR" style="color: #8b949e;">P/C: --</div>
                </div>
                <div id="optionsUnusual" style="font-size: 0.8em;"></div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">‚õìÔ∏è On-Chain Health</div>
            <div id="onchainPanel" style="padding: 10px;">
                <div id="onchainSummary" style="font-size: 0.9em;"></div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">üîî Price Alerts</div>
            <div id="alertsPanel" style="padding: 10px;">
                <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                    <select id="alertTicker" style="flex:1; padding:5px; background:#21262d; border:1px solid #30363d; color:#c9d1d9; border-radius:4px;">
                        <option value="BTC">BTC</option>
                        <option value="ETH">ETH</option>
                        <option value="SOL">SOL</option>
                        <option value="DOGE">DOGE</option>
                    </select>
                    <input id="alertPrice" type="number" placeholder="Price" style="flex:1; padding:5px; background:#21262d; border:1px solid #30363d; color:#c9d1d9; border-radius:4px;">
                    <select id="alertCondition" style="padding:5px; background:#21262d; border:1px solid #30363d; color:#c9d1d9; border-radius:4px;">
                        <option value="above">‚â•</option>
                        <option value="below">‚â§</option>
                    </select>
                    <button onclick="createAlert()" style="padding:5px 10px; background:#238636; border:none; color:#fff; border-radius:4px; cursor:pointer;">+</button>
                </div>
                <div id="activeAlerts" style="font-size: 0.8em; max-height: 100px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- SNIPER PANEL -->
    <div class="panel" style="grid-column: 1 / -1;">
        <div class="panel-title">üî´ SNIPER MODE [PAPER TRADING]</div>
        <div class="stats-grid">
            <div class="stat-box">
                <div style="color:#8b949e;">TOTAL P&L</div>
                <div id="statPnL" style="font-weight:bold;">$0.00</div>
            </div>
            <div class="stat-box">
                <div style="color:#8b949e;">WIN RATE</div>
                <div id="statWinRate" style="font-weight:bold;">0%</div>
            </div>
            <div class="stat-box">
                <div style="color:#8b949e;">TRADES</div>
                <div id="statTrades" style="font-weight:bold;">0</div>
            </div>
            <div class="stat-box">
                <div style="color:#8b949e;">OPEN</div>
                <div id="statOpen" style="font-weight:bold; color:#58a6ff;">0</div>
            </div>
        </div>
        
        <!-- P&L Chart -->
        <div style="height: 150px; margin-bottom: 15px;">
            <canvas id="pnlChart"></canvas>
        </div>
        
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>TICKER</th>
                        <th>ENTRY</th>
                        <th>EXIT</th>
                        <th>P&L</th>
                        <th>STATUS</th>
                        <th>TIME</th>
                    </tr>
                </thead>
                <tbody id="tradesBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const audio = document.getElementById("alertSound");
    let isAlarmActive = false;
    let audioEnabled = false;
    let modalChart = null;
    let heatmapChart = null;
    let pnlChart = null;
    
    // WebSocket for real-time updates
    let ws = null;
    let wsConnected = false;
    let wsReconnectAttempts = 0;

    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws`;
        
        ws = new WebSocket(wsUrl);
        
        ws.onopen = () => {
            console.log('[WS] Connected');
            wsConnected = true;
            wsReconnectAttempts = 0;
            updateConnectionStatus(true);
        };
        
        ws.onmessage = (event) => {
            try {
                const msg = JSON.parse(event.data);
                handleWebSocketMessage(msg);
            } catch (e) {
                console.error('[WS] Parse error:', e);
            }
        };
        
        ws.onclose = () => {
            console.log('[WS] Disconnected');
            wsConnected = false;
            updateConnectionStatus(false);
            
            // Reconnect with exponential backoff
            const delay = Math.min(1000 * Math.pow(2, wsReconnectAttempts), 30000);
            wsReconnectAttempts++;
            setTimeout(connectWebSocket, delay);
        };
        
        ws.onerror = (err) => {
            console.error('[WS] Error:', err);
        };
    }

    function handleWebSocketMessage(msg) {
        switch (msg.type) {
            case 'leaderboard':
                updateLeaderboardFromWS(msg.data);
                break;
            case 'trade':
                showTradeNotification(msg.data);
                break;
            case 'hijack_alert':
                showHijackNotification(msg.data);
                break;
            case 'stats':
                updateStatsFromWS(msg.data);
                break;
        }
    }

    function updateLeaderboardFromWS(assets) {
        const tbody = document.getElementById("gridBody");
        tbody.innerHTML = "";
        let globalPanic = false;

        assets.forEach((asset, index) => {
            const row = document.createElement("tr");
            row.className = "asset-row";
            row.onclick = () => openModal(asset.ticker);
            
            if (asset.isHijacking) globalPanic = true;
            
            const forceClass = asset.isHijacking ? "force-high" : "force-low";
            const statusText = asset.isHijacking ? "‚ö†Ô∏è HIJACK" : "STABLE";
            const statusColor = asset.isHijacking ? "#da3633" : "#238636";

            const narrativeScore = asset.narrativeScore || 0;
            let narrativeColor = "#8b949e";
            if (narrativeScore > 0) narrativeColor = "#238636";
            if (narrativeScore < 0) narrativeColor = "#da3633";
            const narrativeDisplay = narrativeScore > 0 ? `+${narrativeScore}` : narrativeScore.toString();
            const headline = asset.latestHeadline || '--';

            row.innerHTML = `
                <td style="color: #8b949e;">#${index + 1}</td>
                <td class="ticker">${asset.ticker}</td>
                <td>${Number(asset.latestPrice).toFixed(4)}</td>
                <td class="${forceClass}">${asset.hijackForce.toFixed(5)}</td>
                <td style="color:${narrativeColor}; cursor:help;" title="${headline}">${narrativeDisplay}</td>
                <td style="color:${statusColor}">${statusText}</td>
            `;
            tbody.appendChild(row);
        });

        const statusBox = document.getElementById("globalStatus");
        if (globalPanic) {
            statusBox.innerText = "HIJACK DETECTED"; statusBox.className = "status-box critical";
            if (audioEnabled && !isAlarmActive) { audio.play().catch(e => {}); isAlarmActive = true; }
        } else {
            statusBox.innerText = "SECURE"; statusBox.className = "status-box normal"; isAlarmActive = false;
        }
    }

    function showTradeNotification(trade) {
        // Show toast notification for trades
        const emoji = trade.action === 'BUY' ? 'üî´' : (trade.pnl >= 0 ? 'üí∞' : 'üí∏');
        console.log(`[TRADE] ${emoji} ${trade.action} ${trade.ticker} @ $${trade.price.toFixed(4)}`);
    }

    function showHijackNotification(alert) {
        console.log(`[ALERT] ‚ö†Ô∏è Hijack on ${alert.ticker} - Force: ${alert.force.toFixed(4)}`);
    }

    function updateStatsFromWS(stats) {
        const pnlValue = parseFloat(stats.totalPnL);
        document.getElementById("statPnL").innerText = `$${stats.totalPnL}`;
        document.getElementById("statPnL").className = pnlValue >= 0 ? 'profit' : 'loss';
        document.getElementById("statWinRate").innerText = stats.winRate;
        document.getElementById("statTrades").innerText = stats.totalTrades;
        document.getElementById("statOpen").innerText = stats.openPositions;
    }

    function updateConnectionStatus(connected) {
        // Add visual indicator for WS connection
        const header = document.querySelector('.header');
        let indicator = document.getElementById('wsIndicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'wsIndicator';
            indicator.style.cssText = 'font-size:0.7em; padding:3px 8px; border-radius:3px;';
            header.appendChild(indicator);
        }
        indicator.innerText = connected ? 'üü¢ LIVE' : 'üî¥ RECONNECTING';
        indicator.style.background = connected ? '#238636' : '#da3633';
    }

    function enableAudio() {
        audio.play().then(() => { audio.pause(); audio.currentTime = 0; audioEnabled = true; document.getElementById('startOverlay').style.display = 'none'; });
        // Connect WebSocket after user interaction
        connectWebSocket();
    }

    // --- MODAL LOGIC (The Microscope) ---
    async function openModal(ticker) {
        document.getElementById("chartModal").style.display = "block";
        document.getElementById("modalTitle").innerText = `// ${ticker} INSPECTION`;
        const ctx = document.getElementById("modalCanvas").getContext('2d');
        if (modalChart) modalChart.destroy();

        // Fetch history
        const res = await fetch(`/api/v1/sentiment/${ticker}`);
        const json = await res.json();
        
        // Handle data shape
        const history = json.data.history || json.data || [];
        const prices = Array.isArray(history) ? history.map(h => h.score || h) : [];

        modalChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: prices.map(() => ''),
                datasets: [{ data: prices, borderColor: '#58a6ff', backgroundColor: 'rgba(88, 166, 255, 0.1)', borderWidth: 2, tension: 0.1, fill: true }]
            },
            options: { responsive: true, scales: { x: { display: false }, y: { grid: { color: "#30363d" } } }, plugins: { legend: { display: false } } }
        });
    }

    function closeModal() { document.getElementById("chartModal").style.display = "none"; }
    window.onclick = function(event) { if (event.target == document.getElementById("chartModal")) closeModal(); }

    // --- DASHBOARD CORE ---
    async function updateDashboard() {
        try {
            // 1. UPDATE LEADERBOARD
            const res = await fetch("/api/v1/sentiment/leaderboard");
            const json = await res.json();
            
            if (json.success) {
                const assets = json.data;
                const tbody = document.getElementById("gridBody");
                tbody.innerHTML = "";
                let globalPanic = false;

                assets.forEach((asset, index) => {
                    const row = document.createElement("tr");
                    row.className = "asset-row";
                    row.onclick = () => openModal(asset.ticker);
                    
                    if (asset.isHijacking) globalPanic = true;
                    
                    const forceClass = asset.isHijacking ? "force-high" : "force-low";
                    const statusText = asset.isHijacking ? "‚ö†Ô∏è HIJACK" : "STABLE";
                    const statusColor = asset.isHijacking ? "#da3633" : "#238636";

                    // NARRATIVE SCORING
                    const narrativeScore = asset.narrativeScore || 0;
                    let narrativeColor = "#8b949e"; // Grey (Neutral)
                    if (narrativeScore > 0) narrativeColor = "#238636"; // Green (Bullish)
                    if (narrativeScore < 0) narrativeColor = "#da3633"; // Red (Bearish)
                    const narrativeDisplay = narrativeScore > 0 ? `+${narrativeScore}` : narrativeScore.toString();
                    const headline = asset.latestHeadline || '--';

                    row.innerHTML = `
                        <td style="color: #8b949e;">#${index + 1}</td>
                        <td class="ticker">${asset.ticker}</td>
                        <td>${Number(asset.latestPrice).toFixed(4)}</td>
                        <td class="${forceClass}">${asset.hijackForce.toFixed(5)}</td>
                        <td style="color:${narrativeColor}; cursor:help;" title="${headline}">${narrativeDisplay}</td>
                        <td style="color:${statusColor}">${statusText}</td>
                    `;
                    tbody.appendChild(row);
                });

                const statusBox = document.getElementById("globalStatus");
                if (globalPanic) {
                    statusBox.innerText = "HIJACK DETECTED"; statusBox.className = "status-box critical";
                    if (audioEnabled && !isAlarmActive) { audio.play().catch(e => {}); isAlarmActive = true; }
                } else {
                    statusBox.innerText = "SECURE"; statusBox.className = "status-box normal"; isAlarmActive = false;
                }
            }

            // 2. UPDATE HEATMAP (Phase 4 Feature)
            const heatRes = await fetch("/api/v1/sentiment/heatmap");
            const heatJson = await heatRes.json();
            
            if (heatJson.success && heatJson.data.length > 0) {
                updateHeatmap(heatJson.data);
            }

            // 3. UPDATE SNIPER PANEL (Phase 5)
            await updateSniperPanel();

        } catch (err) { console.error("Sync lost", err); }
    }

    // --- SNIPER PANEL UPDATE ---
    async function updateSniperPanel() {
        try {
            // Fetch stats
            const statsRes = await fetch("/api/v1/sentiment/stats");
            const statsJson = await statsRes.json();
            
            if (statsJson.success) {
                const s = statsJson.data;
                const pnlValue = parseFloat(s.totalPnL);
                document.getElementById("statPnL").innerText = `$${s.totalPnL}`;
                document.getElementById("statPnL").className = pnlValue >= 0 ? 'profit' : 'loss';
                document.getElementById("statWinRate").innerText = s.winRate;
                document.getElementById("statTrades").innerText = s.totalTrades;
                document.getElementById("statOpen").innerText = s.openPositions;
            }

            // Fetch recent trades
            const tradesRes = await fetch("/api/v1/sentiment/trades");
            const tradesJson = await tradesRes.json();
            
            if (tradesJson.success) {
                const tbody = document.getElementById("tradesBody");
                tbody.innerHTML = "";
                
                tradesJson.data.forEach(trade => {
                    const row = document.createElement("tr");
                    const pnl = trade.profit ? parseFloat(trade.profit).toFixed(2) : '-';
                    const pnlClass = trade.profit && parseFloat(trade.profit) >= 0 ? 'profit' : 'loss';
                    const statusColor = trade.status === 'OPEN' ? '#58a6ff' : '#8b949e';
                    const time = new Date(trade.opened_at).toLocaleTimeString();
                    
                    row.innerHTML = `
                        <td class="ticker">${trade.ticker}</td>
                        <td>$${parseFloat(trade.entry_price).toFixed(4)}</td>
                        <td>${trade.exit_price ? '$' + parseFloat(trade.exit_price).toFixed(4) : '-'}</td>
                        <td class="${pnlClass}">${pnl !== '-' ? '$' + pnl : '-'}</td>
                        <td style="color:${statusColor}">${trade.status}</td>
                        <td style="color:#8b949e">${time}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // Fetch P&L history for chart
            const pnlRes = await fetch("/api/v1/sentiment/pnl-history");
            const pnlJson = await pnlRes.json();
            
            if (pnlJson.success && pnlJson.data.length > 0) {
                updatePnLChart(pnlJson.data);
            }
        } catch (err) {
            // Silently fail - table might not exist yet
        }
    }

    // --- P&L CHART ---
    function updatePnLChart(data) {
        const ctx = document.getElementById("pnlChart").getContext('2d');
        const labels = data.map(d => d.date ? d.date.substring(5) : ''); // MM-DD format
        const pnlValues = data.map(d => parseFloat(d.daily_pnl || 0));
        
        // Calculate cumulative P&L
        let cumulative = 0;
        const cumulativeData = pnlValues.map(v => { cumulative += v; return cumulative; });

        if (pnlChart) {
            pnlChart.data.labels = labels;
            pnlChart.data.datasets[0].data = cumulativeData;
            pnlChart.update('none');
        } else {
            pnlChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cumulative P&L',
                        data: cumulativeData,
                        borderColor: cumulative >= 0 ? '#238636' : '#da3633',
                        backgroundColor: cumulative >= 0 ? 'rgba(35,134,54,0.1)' : 'rgba(218,54,51,0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#8b949e', font: { size: 9 } } },
                        y: { grid: { color: '#21262d' }, ticks: { color: '#8b949e', callback: v => '$' + v } }
                    }
                }
            });
        }
    }

    function updateHeatmap(data) {
        const ctx = document.getElementById("heatmapCanvas").getContext('2d');
        const labels = data.map(d => d.ticker);
        const vols = data.map(d => d.total_vol);

        if (heatmapChart) {
            heatmapChart.data.labels = labels;
            heatmapChart.data.datasets[0].data = vols;
            heatmapChart.update('none'); // 'none' mode prevents annoying animations on every update
        } else {
            heatmapChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ 
                        label: 'Hourly Volume', 
                        data: vols, 
                        backgroundColor: '#238636', 
                        borderRadius: 4,
                        barThickness: 10
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { 
                        y: { display: false }, 
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#8b949e', font: { size: 10 } } 
                        } 
                    }, 
                    plugins: { legend: { display: false } } 
                }
            });
        }
    }

    // Refresh every 3 seconds (fallback for non-WS data like heatmap, trades, pnl history)
    // WebSocket handles leaderboard in real-time
    setInterval(async () => {
        try {
            // Heatmap
            const heatRes = await fetch("/api/v1/sentiment/heatmap");
            const heatJson = await heatRes.json();
            if (heatJson.success && heatJson.data.length > 0) {
                updateHeatmap(heatJson.data);
            }

            // Sniper panel (trades, stats, pnl)
            await updateSniperPanel();
        } catch (err) { console.error("Sync lost", err); }
    }, 3000);
    
    // Initial load via HTTP (before WS connects)
    updateDashboard();

    // --- NEW INTEL PANELS ---
    async function updateFearGreed() {
        try {
            const res = await fetch("/api/v1/sentiment/fear-greed");
            const json = await res.json();
            if (json.success) {
                const data = json.data;
                const gauge = document.getElementById("fearGreedGauge");
                const label = document.getElementById("fearGreedLabel");
                const comps = document.getElementById("fearGreedComponents");
                
                gauge.innerText = data.value;
                label.innerText = data.label || 'Neutral';
                
                // Color based on value
                if (data.value <= 25) { gauge.style.color = "#da3633"; label.style.color = "#da3633"; }
                else if (data.value <= 45) { gauge.style.color = "#f85149"; }
                else if (data.value <= 55) { gauge.style.color = "#8b949e"; }
                else if (data.value <= 75) { gauge.style.color = "#7ee787"; }
                else { gauge.style.color = "#238636"; label.style.color = "#238636"; }
                
                // Components
                comps.innerHTML = Object.entries(data.components || {}).map(([k,v]) => 
                    `<span style="background:#21262d; padding:2px 6px; border-radius:3px; font-size:0.7em;">${k}: ${v}</span>`
                ).join('');
            }
        } catch(e) { console.log('Fear/Greed unavailable'); }
    }

    async function updateTwitterSentiment() {
        try {
            const res = await fetch("/api/v1/sentiment/twitter/trending");
            const json = await res.json();
            if (json.success && json.data.length > 0) {
                const trending = document.getElementById("twitterTrending");
                const mentions = document.getElementById("twitterMentions");
                
                trending.innerHTML = json.data.slice(0, 5).map(t => {
                    const score = t.sentiment?.score || 0;
                    const color = score > 0 ? '#238636' : score < 0 ? '#da3633' : '#8b949e';
                    return `<div style="display:flex; justify-content:space-between; padding:3px 0; border-bottom:1px solid #21262d;">
                        <span>${t.asset}</span>
                        <span style="color:${color}">${score > 0 ? '+' : ''}${score.toFixed(1)}</span>
                    </div>`;
                }).join('');
                
                const total = json.data.reduce((s, t) => s + (t.sentiment?.tweets || 0), 0);
                mentions.innerText = `${total} tweets analyzed`;
            } else {
                document.getElementById("twitterTrending").innerHTML = '<div style="color:#8b949e;">Scanning Twitter...</div>';
            }
        } catch(e) { console.log('Twitter unavailable'); }
    }

    async function updateMLPredictions() {
        try {
            const res = await fetch("/api/v1/sentiment/ml/high-confidence");
            const json = await res.json();
            if (json.success) {
                const panel = document.getElementById("mlHighConfidence");
                panel.innerHTML = json.data.slice(0, 4).map(p => {
                    const dir = p.predicted_direction === 'up' ? '‚Üë' : '‚Üì';
                    const color = p.predicted_direction === 'up' ? '#238636' : '#da3633';
                    const conf = p.confidence > 1 ? p.confidence : (p.confidence * 100); // Handle both 0-1 and 0-100 scales
                    return `<div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #21262d;">
                        <span class="ticker">${p.ticker}</span>
                        <span style="color:${color}">${dir} ${conf.toFixed(0)}%</span>
                    </div>`;
                }).join('') || '<div style="color:#8b949e;">No high-confidence signals</div>';
            }
        } catch(e) { console.log('ML unavailable'); }
    }

    async function updateOptionsFlow() {
        try {
            const res = await fetch("/api/v1/sentiment/options/sentiment");
            const json = await res.json();
            if (json.success) {
                const sent = document.getElementById("optionsSentiment");
                const pcr = document.getElementById("optionsPCR");
                
                const sentiment = json.data.sentiment || json.data.overall_sentiment || 'NEUTRAL';
                sent.innerText = sentiment.toUpperCase();
                sent.style.color = sentiment.toLowerCase() === 'bullish' ? '#238636' : 
                                  sentiment.toLowerCase() === 'bearish' ? '#da3633' : '#8b949e';
                
                // Get P/C ratio from metrics
                const metricsRes = await fetch("/api/v1/sentiment/options");
                const metricsJson = await metricsRes.json();
                if (metricsJson.success && metricsJson.data.length > 0) {
                    const avgPCR = metricsJson.data.reduce((s, m) => s + (m.putCallRatio || 0), 0) / metricsJson.data.length;
                    pcr.innerText = `P/C: ${avgPCR.toFixed(2)}`;
                }
            }
            
            // Unusual activity
            const unusualRes = await fetch("/api/v1/sentiment/options/unusual");
            const unusualJson = await unusualRes.json();
            if (unusualJson.success && unusualJson.data.length > 0) {
                const panel = document.getElementById("optionsUnusual");
                panel.innerHTML = unusualJson.data.slice(0, 3).map(o => 
                    `<div style="color:#f0883e;">‚ö° ${o.ticker} ${o.type} $${o.strike?.toLocaleString() || 'N/A'}</div>`
                ).join('');
            } else {
                document.getElementById("optionsUnusual").innerHTML = '<div style="color:#8b949e;">Monitoring flows...</div>';
            }
        } catch(e) { console.log('Options unavailable'); }
    }

    async function updateOnChain() {
        try {
            const res = await fetch("/api/v1/sentiment/onchain/summary");
            const json = await res.json();
            if (json.success && json.data.length > 0) {
                const panel = document.getElementById("onchainSummary");
                panel.innerHTML = json.data.slice(0, 4).map(c => {
                    const score = c.healthScore || c.health_score || 50;
                    const health = score >= 70 ? 'üü¢' : score >= 40 ? 'üü°' : 'üî¥';
                    return `<div style="display:flex; justify-content:space-between; padding:3px 0; border-bottom:1px solid #21262d;">
                        <span>${c.ticker}</span>
                        <span>${health} ${score}</span>
                    </div>`;
                }).join('');
            } else {
                document.getElementById("onchainSummary").innerHTML = '<div style="color:#8b949e;">Fetching blockchain data...</div>';
            }
        } catch(e) { console.log('On-chain unavailable'); }
    }

    // --- PRICE ALERTS ---
    let userAlerts = JSON.parse(localStorage.getItem('priceAlerts') || '[]');
    
    async function createAlert() {
        const ticker = document.getElementById("alertTicker").value;
        const price = parseFloat(document.getElementById("alertPrice").value);
        const condition = document.getElementById("alertCondition").value;
        
        if (!price || isNaN(price)) { alert('Enter a valid price'); return; }
        
        try {
            const res = await fetch("/api/v1/sentiment/alerts", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ticker, target_price: price, condition })
            });
            const json = await res.json();
            if (json.success) {
                userAlerts.push({ id: json.data.id, ticker, price, condition, active: true });
                localStorage.setItem('priceAlerts', JSON.stringify(userAlerts));
                renderAlerts();
                document.getElementById("alertPrice").value = '';
            }
        } catch(e) {
            // Fallback: local-only alert
            userAlerts.push({ id: Date.now(), ticker, price, condition, active: true });
            localStorage.setItem('priceAlerts', JSON.stringify(userAlerts));
            renderAlerts();
            document.getElementById("alertPrice").value = '';
        }
    }
    
    function renderAlerts() {
        const panel = document.getElementById("activeAlerts");
        panel.innerHTML = userAlerts.filter(a => a.active).map(a => 
            `<div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #21262d;">
                <span>${a.ticker} ${a.condition === 'above' ? '‚â•' : '‚â§'} $${a.price}</span>
                <span style="color:#da3633; cursor:pointer;" onclick="deleteAlert(${a.id})">‚úï</span>
            </div>`
        ).join('') || '<div style="color:#8b949e;">No active alerts</div>';
    }
    
    function deleteAlert(id) {
        userAlerts = userAlerts.filter(a => a.id !== id);
        localStorage.setItem('priceAlerts', JSON.stringify(userAlerts));
        renderAlerts();
        // Also delete from server
        fetch(`/api/v1/sentiment/alerts/${id}`, { method: 'DELETE' }).catch(() => {});
    }
    
    async function checkAlerts() {
        if (userAlerts.length === 0) return;
        try {
            const res = await fetch("/api/v1/sentiment/leaderboard");
            const json = await res.json();
            if (!json.success) return;
            
            const prices = {};
            json.data.forEach(a => prices[a.ticker] = a.latestPrice);
            
            userAlerts.forEach(alert => {
                if (!alert.active) return;
                const currentPrice = prices[alert.ticker];
                if (!currentPrice) return;
                
                const triggered = alert.condition === 'above' 
                    ? currentPrice >= alert.price 
                    : currentPrice <= alert.price;
                    
                if (triggered) {
                    alert.active = false;
                    localStorage.setItem('priceAlerts', JSON.stringify(userAlerts));
                    renderAlerts();
                    
                    // Show notification
                    if (Notification.permission === 'granted') {
                        new Notification(`Price Alert: ${alert.ticker}`, {
                            body: `${alert.ticker} hit $${currentPrice.toFixed(2)} (target: ${alert.condition} $${alert.price})`,
                            icon: 'üìà'
                        });
                    }
                    if (audioEnabled) audio.play().catch(() => {});
                }
            });
        } catch(e) {}
    }

    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }

    // Update new panels every 10 seconds
    setInterval(() => {
        updateFearGreed();
        updateTwitterSentiment();
        updateMLPredictions();
        updateOptionsFlow();
        updateOnChain();
        checkAlerts();
    }, 10000);
    
    // Initial load of new panels
    setTimeout(() => {
        updateFearGreed();
        updateTwitterSentiment();
        updateMLPredictions();
        updateOptionsFlow();
        updateOnChain();
        renderAlerts();
    }, 1000);
</script>
</body>
</html>